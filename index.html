<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÖ Santa Sled Run</title>
    <!--
    ============================================
    SANTA SLED RUN - Christmas Browser Game
    ============================================
    
    HOW THE GAME WORKS:
    - Control a sled at the bottom of the screen
    - Catch falling gifts (üéÅ) to score points
    - Avoid snowballs (‚ùÑÔ∏è) - hitting one ends the game
    - Difficulty increases as your score grows
    - Daily leaderboard tracks best scores for each day
    
    CONTROLS:
    - Left Arrow (‚Üê) or A key: Move sled left
    - Right Arrow (‚Üí) or D key: Move sled right
    
    CUSTOMIZATION (tweak these variables in the CONFIG object):
    - SLED_SPEED: How fast the sled moves (default: 8)
    - BASE_FALL_SPEED: Initial falling speed of objects (default: 2)
    - BASE_SPAWN_INTERVAL: Initial spawn rate in ms (default: 1500)
    - DIFFICULTY_INCREMENT: Points needed per difficulty level (default: 5)
    - SPEED_INCREASE_PER_LEVEL: How much faster objects fall per level (default: 0.5)
    - SPAWN_DECREASE_PER_LEVEL: How much faster spawning gets per level in ms (default: 100)
    - GIFT_PROBABILITY: Chance of spawning a gift vs snowball (default: 0.6 = 60%)
    - LEADERBOARD_MAX_ENTRIES: Max entries in daily leaderboard (default: 10)
    
    ============================================
    -->
    <style>
        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #0a1628 0%, #1a2a4a 50%, #0d1a2d 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #e8f0ff;
            overflow-x: hidden;
        }

        /* Snowfall background effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, white, transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 160px 120px, white, transparent);
            background-size: 200px 200px;
            animation: snowfall 10s linear infinite;
            pointer-events: none;
            z-index: -1;
            opacity: 0.4;
        }

        @keyframes snowfall {
            from { background-position: 0 0; }
            to { background-position: 0 200px; }
        }

        /* ========== MAIN LAYOUT ========== */
        .main-wrapper {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ========== GAME CONTAINER ========== */
        .game-container {
            background: rgba(10, 25, 50, 0.8);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 
                0 0 40px rgba(100, 150, 255, 0.15),
                0 0 80px rgba(50, 100, 200, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(100, 150, 255, 0.2);
            max-width: 100%;
        }

        /* ========== HEADER ========== */
        .game-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .game-title {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 50%, #6bcf6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(255, 100, 100, 0.3);
            margin-bottom: 8px;
        }

        .instructions {
            font-size: 0.95rem;
            color: #9bb8e8;
            margin-bottom: 12px;
        }

        .instructions kbd {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 2px 8px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        /* Show appropriate control hints based on device */
        .mobile-hint {
            display: none;
        }

        @media (hover: none) and (pointer: coarse) {
            /* Touch device detected */
            .desktop-hint {
                display: none;
            }
            .mobile-hint {
                display: inline;
            }
        }

        /* ========== PLAYER INFO ========== */
        .player-info {
            text-align: center;
            margin-bottom: 12px;
            padding: 8px 16px;
            background: rgba(107, 207, 107, 0.15);
            border-radius: 8px;
            border: 1px solid rgba(107, 207, 107, 0.3);
        }

        .player-info span {
            color: #6bcf6b;
            font-weight: 600;
        }

        /* ========== SCORE PANEL ========== */
        .score-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: rgba(0, 20, 50, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(100, 150, 255, 0.15);
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7a9fd4;
            margin-bottom: 4px;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .score-value.current {
            color: #ffd93d;
        }

        .score-value.level {
            color: #6bcf6b;
        }

        .score-value.high {
            color: #ff6b6b;
        }

        /* ========== CANVAS ========== */
        #gameCanvas {
            display: block;
            border-radius: 8px;
            border: 2px solid rgba(100, 150, 255, 0.3);
            background: linear-gradient(180deg, #0d1a2d 0%, #152238 100%);
        }

        /* ========== OVERLAYS ========== */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 20, 40, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
            padding: 20px;
        }

        .overlay.visible {
            display: flex;
        }

        /* ========== USERNAME MODAL ========== */
        .username-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffd93d;
            margin-bottom: 8px;
            text-align: center;
        }

        .username-subtitle {
            font-size: 1rem;
            color: #9bb8e8;
            margin-bottom: 24px;
            text-align: center;
        }

        .username-input {
            width: 100%;
            max-width: 280px;
            padding: 14px 18px;
            font-size: 1.1rem;
            border: 2px solid rgba(100, 150, 255, 0.3);
            border-radius: 12px;
            background: rgba(0, 20, 50, 0.8);
            color: #e8f0ff;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }

        .username-input:focus {
            border-color: #6bcf6b;
            box-shadow: 0 0 20px rgba(107, 207, 107, 0.3);
        }

        .username-input::placeholder {
            color: #7a9fd4;
        }

        .start-btn {
            margin-top: 20px;
            background: linear-gradient(135deg, #6bcf6b 0%, #4aa84a 100%);
            color: white;
            border: none;
            padding: 14px 48px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(107, 207, 107, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(107, 207, 107, 0.6);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ========== GAME OVER OVERLAY ========== */
        .game-over-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ff6b6b;
            margin-bottom: 16px;
            text-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
        }

        .game-over-score {
            font-size: 1.3rem;
            color: #e8f0ff;
            margin-bottom: 8px;
        }

        .game-over-score span {
            color: #ffd93d;
            font-weight: 700;
        }

        .new-high-score {
            font-size: 1.1rem;
            color: #6bcf6b;
            margin-bottom: 20px;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .leaderboard-position {
            font-size: 1rem;
            color: #ffd93d;
            margin-bottom: 20px;
        }

        .play-again-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 100, 100, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .play-again-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(255, 100, 100, 0.6);
        }

        .play-again-btn:active {
            transform: translateY(0);
        }

        /* ========== CANVAS WRAPPER ========== */
        .canvas-wrapper {
            position: relative;
            /* Prevent text selection on touch */
            -webkit-user-select: none;
            user-select: none;
            /* Prevent callout on long press */
            -webkit-touch-callout: none;
        }

        /* Touch zone indicators (mobile only) */
        .touch-zones {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        @media (hover: none) and (pointer: coarse) {
            .touch-zones {
                display: flex;
            }
        }

        .touch-zone {
            flex: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 80px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .touch-zone.active {
            opacity: 1;
        }

        .touch-zone-left {
            background: linear-gradient(90deg, rgba(100, 150, 255, 0.15) 0%, transparent 100%);
            border-radius: 8px 0 0 8px;
        }

        .touch-zone-right {
            background: linear-gradient(90deg, transparent 0%, rgba(100, 150, 255, 0.15) 100%);
            border-radius: 0 8px 8px 0;
        }

        .touch-zone-icon {
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ========== LEADERBOARD PANEL ========== */
        .leaderboard-container {
            background: rgba(10, 25, 50, 0.8);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 0 40px rgba(100, 150, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(100, 150, 255, 0.2);
            width: 280px;
            max-height: 700px;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .leaderboard-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ffd93d;
            margin-bottom: 4px;
        }

        .leaderboard-date {
            font-size: 0.85rem;
            color: #7a9fd4;
        }

        .leaderboard-list {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(0, 20, 50, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(100, 150, 255, 0.1);
            transition: all 0.2s ease;
        }

        .leaderboard-item:hover {
            background: rgba(0, 30, 70, 0.6);
        }

        .leaderboard-item.current-player {
            background: rgba(107, 207, 107, 0.15);
            border-color: rgba(107, 207, 107, 0.3);
        }

        .leaderboard-item.top-3:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 180, 0, 0.1) 100%);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .leaderboard-item.top-3:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.2) 0%, rgba(160, 160, 160, 0.1) 100%);
            border-color: rgba(192, 192, 192, 0.4);
        }

        .leaderboard-item.top-3:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2) 0%, rgba(180, 100, 30, 0.1) 100%);
            border-color: rgba(205, 127, 50, 0.4);
        }

        .leaderboard-rank {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            border-radius: 50%;
            margin-right: 12px;
            background: rgba(100, 150, 255, 0.2);
            color: #9bb8e8;
        }

        .leaderboard-item.top-3:nth-child(1) .leaderboard-rank {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #1a1a1a;
        }

        .leaderboard-item.top-3:nth-child(2) .leaderboard-rank {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #1a1a1a;
        }

        .leaderboard-item.top-3:nth-child(3) .leaderboard-rank {
            background: linear-gradient(135deg, #cd7f32, #b46420);
            color: #1a1a1a;
        }

        .leaderboard-name {
            flex: 1;
            font-size: 0.95rem;
            color: #e8f0ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-score {
            font-weight: 700;
            font-size: 1rem;
            color: #ffd93d;
            margin-left: 8px;
        }

        .leaderboard-empty {
            text-align: center;
            color: #7a9fd4;
            padding: 30px 20px;
            font-size: 0.95rem;
        }

        .leaderboard-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* ========== WATERMARK ========== */
        .watermark {
            position: fixed;
            bottom: 12px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            color: rgba(155, 184, 232, 0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
            pointer-events: none;
            z-index: 100;
        }

        .watermark span {
            font-weight: 600;
            color: rgba(200, 220, 255, 0.6);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 800px) {
            .main-wrapper {
                flex-direction: column;
                align-items: center;
            }

            .leaderboard-container {
                width: 100%;
                max-width: 480px;
                margin-top: 20px;
            }
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 16px;
            }
            
            .game-title {
                font-size: 1.6rem;
            }
            
            .instructions {
                font-size: 0.85rem;
            }
            
            .score-panel {
                padding: 10px 12px;
            }
            
            .score-value {
                font-size: 1.2rem;
            }
            
            .game-over-title {
                font-size: 1.8rem;
            }

            .username-title {
                font-size: 1.5rem;
            }

            .leaderboard-container {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Watermark -->
    <div class="watermark"><span>Andreassen</span> Technology AS</div>

    <div class="main-wrapper">
        <div class="game-container">
            <!-- Header Section -->
            <div class="game-header">
                <h1 class="game-title">üéÖ Santa Sled Run üéÑ</h1>
            <p class="instructions">
                <span class="desktop-hint">Use <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> or <kbd>A</kbd> <kbd>D</kbd> to move.</span>
                <span class="mobile-hint">Touch left/right side to move.</span>
                Catch gifts üéÅ, avoid snowballs ‚ùÑÔ∏è!
            </p>
            </div>

            <!-- Player Info -->
            <div class="player-info" id="playerInfo" style="display: none;">
                Playing as: <span id="currentPlayerName">-</span>
            </div>

            <!-- Score Panel -->
            <div class="score-panel">
                <div class="score-item">
                    <div class="score-label">Score</div>
                    <div class="score-value current" id="scoreDisplay">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Level</div>
                    <div class="score-value level" id="levelDisplay">1</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Best</div>
                    <div class="score-value high" id="highScoreDisplay">0</div>
                </div>
            </div>

            <!-- Game Canvas -->
            <div class="canvas-wrapper">
                <canvas id="gameCanvas" width="480" height="600"></canvas>
                
                <!-- Touch Zone Indicators (Mobile) -->
                <div class="touch-zones">
                    <div class="touch-zone touch-zone-left" id="touchZoneLeft">
                        <span class="touch-zone-icon">‚óÄ</span>
                    </div>
                    <div class="touch-zone touch-zone-right" id="touchZoneRight">
                        <span class="touch-zone-icon">‚ñ∂</span>
                    </div>
                </div>
                
                <!-- Username Entry Overlay -->
                <div class="overlay visible" id="usernameOverlay">
                    <div class="username-title">üéÑ Welcome! üéÑ</div>
                    <div class="username-subtitle">Enter your name to join today's leaderboard</div>
                    <input type="text" class="username-input" id="usernameInput" placeholder="Your name..." maxlength="20" autocomplete="off">
                    <button class="start-btn" id="startBtn" disabled>Start Game</button>
                </div>

                <!-- Game Over Overlay -->
                <div class="overlay" id="gameOverOverlay">
                    <div class="game-over-title">üí• Game Over!</div>
                    <div class="game-over-score">Your score: <span id="finalScore">0</span></div>
                    <div class="game-over-score">Best score: <span id="finalHighScore">0</span></div>
                    <div class="new-high-score" id="newHighScoreMsg" style="display: none;">
                        üéâ New Personal Best! üéâ
                    </div>
                    <div class="leaderboard-position" id="leaderboardPosition" style="display: none;"></div>
                    <button class="play-again-btn" id="playAgainBtn">Play Again</button>
                </div>
            </div>
        </div>

        <!-- Daily Leaderboard -->
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div class="leaderboard-title">üèÜ Today's Leaderboard</div>
                <div class="leaderboard-date" id="leaderboardDate"></div>
            </div>
            <ul class="leaderboard-list" id="leaderboardList">
                <li class="leaderboard-empty">
                    <div class="leaderboard-empty-icon">üéÅ</div>
                    No scores yet today!<br>Be the first to play!
                </li>
            </ul>
        </div>
    </div>

    <script>
        // ============================================
        // GAME CONFIGURATION
        // ============================================
        // Tweak these values to customize game difficulty
        const CONFIG = {
            // Sled settings
            SLED_WIDTH: 80,
            SLED_HEIGHT: 30,
            SLED_SPEED: 8,
            
            // Object sizes
            GIFT_SIZE: 32,
            SNOWBALL_RADIUS: 15,
            
            // Initial difficulty settings
            BASE_FALL_SPEED: 2,
            BASE_SPAWN_INTERVAL: 1500, // milliseconds
            
            // Difficulty scaling
            DIFFICULTY_INCREMENT: 5,      // Points needed to increase level
            SPEED_INCREASE_PER_LEVEL: 0.5, // Fall speed increase per level
            SPAWN_DECREASE_PER_LEVEL: 100, // Spawn interval decrease per level (ms)
            MIN_SPAWN_INTERVAL: 400,       // Minimum spawn interval (ms)
            
            // Spawn probabilities
            GIFT_PROBABILITY: 0.6, // 60% chance for gift, 40% for snowball
            
            // Leaderboard settings
            LEADERBOARD_MAX_ENTRIES: 10, // Maximum entries in daily leaderboard
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const usernameOverlay = document.getElementById('usernameOverlay');
        const finalScoreDisplay = document.getElementById('finalScore');
        const finalHighScoreDisplay = document.getElementById('finalHighScore');
        const newHighScoreMsg = document.getElementById('newHighScoreMsg');
        const leaderboardPosition = document.getElementById('leaderboardPosition');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const usernameInput = document.getElementById('usernameInput');
        const startBtn = document.getElementById('startBtn');
        const playerInfo = document.getElementById('playerInfo');
        const currentPlayerName = document.getElementById('currentPlayerName');
        const leaderboardList = document.getElementById('leaderboardList');
        const leaderboardDate = document.getElementById('leaderboardDate');

        // ============================================
        // GAME STATE
        // ============================================
        let score = 0;
        let level = 1;
        let highScore = 0;
        let isGameOver = false;
        let isGameStarted = false;
        let lastSpawnTime = 0;
        let currentSpawnInterval = CONFIG.BASE_SPAWN_INTERVAL;
        let currentFallSpeed = CONFIG.BASE_FALL_SPEED;
        let playerName = '';

        // Input state
        const keys = {
            left: false,
            right: false
        };

        // Game objects arrays
        let gifts = [];
        let snowballs = [];

        // ============================================
        // DAILY LEADERBOARD SYSTEM (localStorage)
        // ============================================
        // Get today's date as a string key (YYYY-MM-DD format)
        function getTodayKey() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Get formatted date for display
        function getFormattedDate() {
            const today = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            return today.toLocaleDateString('en-US', options);
        }

        // Load daily leaderboard from localStorage
        // Structure: { date: "YYYY-MM-DD", scores: [{name, score, timestamp}] }
        function loadDailyLeaderboard() {
            const todayKey = getTodayKey();
            const stored = localStorage.getItem('santaSledRunDailyLeaderboard');
            
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    // Check if it's today's leaderboard
                    if (data.date === todayKey) {
                        return data.scores || [];
                    }
                } catch (e) {
                    console.error('Error parsing leaderboard:', e);
                }
            }
            
            // Return empty array if no valid data for today
            return [];
        }

        // Save score to daily leaderboard
        function saveToDailyLeaderboard(name, newScore) {
            const todayKey = getTodayKey();
            let scores = loadDailyLeaderboard();
            
            // Check if player already has a score today
            const existingIndex = scores.findIndex(s => s.name.toLowerCase() === name.toLowerCase());
            
            if (existingIndex !== -1) {
                // Only update if new score is better
                if (newScore > scores[existingIndex].score) {
                    scores[existingIndex].score = newScore;
                    scores[existingIndex].timestamp = Date.now();
                }
            } else {
                // Add new entry
                scores.push({
                    name: name,
                    score: newScore,
                    timestamp: Date.now()
                });
            }
            
            // Sort by score (descending), then by timestamp (earlier first for ties)
            scores.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.timestamp - b.timestamp;
            });
            
            // Keep only top entries
            scores = scores.slice(0, CONFIG.LEADERBOARD_MAX_ENTRIES);
            
            // Save to localStorage
            localStorage.setItem('santaSledRunDailyLeaderboard', JSON.stringify({
                date: todayKey,
                scores: scores
            }));
            
            return scores;
        }

        // Get player's position on leaderboard
        function getLeaderboardPosition(name, currentScore) {
            const scores = loadDailyLeaderboard();
            
            // Find position based on current score
            let position = 1;
            for (const entry of scores) {
                if (entry.score > currentScore) {
                    position++;
                } else if (entry.score === currentScore && entry.name.toLowerCase() !== name.toLowerCase()) {
                    // For ties, check timestamp - but we'll count same score as same position
                }
            }
            
            return position;
        }

        // Render the leaderboard UI
        function renderLeaderboard() {
            const scores = loadDailyLeaderboard();
            leaderboardDate.textContent = getFormattedDate();
            
            if (scores.length === 0) {
                leaderboardList.innerHTML = `
                    <li class="leaderboard-empty">
                        <div class="leaderboard-empty-icon">üéÅ</div>
                        No scores yet today!<br>Be the first to play!
                    </li>
                `;
                return;
            }
            
            leaderboardList.innerHTML = scores.map((entry, index) => {
                const isCurrentPlayer = playerName && entry.name.toLowerCase() === playerName.toLowerCase();
                const isTop3 = index < 3;
                
                return `
                    <li class="leaderboard-item ${isCurrentPlayer ? 'current-player' : ''} ${isTop3 ? 'top-3' : ''}">
                        <div class="leaderboard-rank">${index + 1}</div>
                        <div class="leaderboard-name">${escapeHtml(entry.name)}</div>
                        <div class="leaderboard-score">${entry.score}</div>
                    </li>
                `;
            }).join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // SLEDGE CLASS
        // ============================================
        class Sledge {
            constructor() {
                this.width = CONFIG.SLED_WIDTH;
                this.height = CONFIG.SLED_HEIGHT;
                this.x = (canvas.width - this.width) / 2;
                this.y = canvas.height - this.height - 20;
                this.speed = CONFIG.SLED_SPEED;
            }

            update() {
                if (keys.left && this.x > 0) {
                    this.x -= this.speed;
                }
                if (keys.right && this.x < canvas.width - this.width) {
                    this.x += this.speed;
                }
                this.x = Math.max(0, Math.min(canvas.width - this.width, this.x));
            }

            draw() {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                ctx.fillStyle = '#2F2F2F';
                ctx.fillRect(this.x - 5, this.y + this.height - 5, this.width + 10, 6);
                
                ctx.fillStyle = '#cc2222';
                ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, 8);
                
                ctx.fillStyle = '#A0522D';
                ctx.fillRect(this.x + 5, this.y + 18, this.width - 10, 4);
            }

            getHitbox() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height
                };
            }
        }

        // ============================================
        // GIFT CLASS
        // ============================================
        class Gift {
            constructor() {
                this.size = CONFIG.GIFT_SIZE;
                this.x = Math.random() * (canvas.width - this.size);
                this.y = -this.size;
                this.speed = currentFallSpeed;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.1;
            }

            update() {
                this.y += this.speed;
                this.rotation += this.rotationSpeed;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.size / 2, this.y + this.size / 2);
                ctx.rotate(this.rotation);
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üéÅ', 0, 0);
                ctx.restore();
            }

            getHitbox() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.size,
                    height: this.size
                };
            }

            isOffScreen() {
                return this.y > canvas.height;
            }
        }

        // ============================================
        // SNOWBALL CLASS
        // ============================================
        class Snowball {
            constructor() {
                this.radius = CONFIG.SNOWBALL_RADIUS;
                this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
                this.y = -this.radius;
                this.speed = currentFallSpeed;
            }

            update() {
                this.y += this.speed;
            }

            draw() {
                const gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.radius
                );
                gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
                gradient.addColorStop(0.7, 'rgba(220, 235, 255, 1)');
                gradient.addColorStop(1, 'rgba(180, 200, 230, 0.8)');
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(this.x - 4, this.y - 4, this.radius * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fill();
            }

            getHitbox() {
                return {
                    x: this.x,
                    y: this.y,
                    radius: this.radius
                };
            }

            isOffScreen() {
                return this.y > canvas.height + this.radius;
            }
        }

        // ============================================
        // COLLISION DETECTION
        // ============================================
        function checkRectCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function checkRectCircleCollision(rect, circle) {
            const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));
            const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));
            const distanceX = circle.x - closestX;
            const distanceY = circle.y - closestY;
            const distanceSquared = distanceX * distanceX + distanceY * distanceY;
            return distanceSquared < circle.radius * circle.radius;
        }

        // ============================================
        // HIGH SCORE SYSTEM (localStorage)
        // ============================================
        function loadHighScore() {
            const stored = localStorage.getItem('santaSledRunHighScore');
            if (stored) {
                highScore = parseInt(stored, 10);
                if (isNaN(highScore)) highScore = 0;
            }
            highScoreDisplay.textContent = highScore;
        }

        function saveHighScore() {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('santaSledRunHighScore', highScore.toString());
                return true;
            }
            return false;
        }

        // ============================================
        // DIFFICULTY PROGRESSION
        // ============================================
        function calculateLevel() {
            return Math.floor(score / CONFIG.DIFFICULTY_INCREMENT) + 1;
        }

        function updateDifficulty() {
            const newLevel = calculateLevel();
            
            if (newLevel !== level) {
                level = newLevel;
                levelDisplay.textContent = level;
            }
            
            currentFallSpeed = CONFIG.BASE_FALL_SPEED + 
                               (level - 1) * CONFIG.SPEED_INCREASE_PER_LEVEL;
            
            currentSpawnInterval = Math.max(
                CONFIG.MIN_SPAWN_INTERVAL,
                CONFIG.BASE_SPAWN_INTERVAL - (level - 1) * CONFIG.SPAWN_DECREASE_PER_LEVEL
            );
        }

        // ============================================
        // OBJECT SPAWNING
        // ============================================
        function spawnObject(timestamp) {
            if (timestamp - lastSpawnTime >= currentSpawnInterval) {
                lastSpawnTime = timestamp;
                
                if (Math.random() < CONFIG.GIFT_PROBABILITY) {
                    gifts.push(new Gift());
                } else {
                    snowballs.push(new Snowball());
                }
            }
        }

        // ============================================
        // GAME LOOP
        // ============================================
        let sledge;

        function gameLoop(timestamp) {
            if (isGameOver || !isGameStarted) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            updateDifficulty();
            spawnObject(timestamp);
            sledge.update();
            
            for (let i = gifts.length - 1; i >= 0; i--) {
                const gift = gifts[i];
                gift.speed = currentFallSpeed;
                gift.update();
                
                if (checkRectCollision(sledge.getHitbox(), gift.getHitbox())) {
                    score++;
                    scoreDisplay.textContent = score;
                    gifts.splice(i, 1);
                    continue;
                }
                
                if (gift.isOffScreen()) {
                    gifts.splice(i, 1);
                }
            }
            
            for (let i = snowballs.length - 1; i >= 0; i--) {
                const snowball = snowballs[i];
                snowball.speed = currentFallSpeed;
                snowball.update();
                
                if (checkRectCircleCollision(sledge.getHitbox(), snowball.getHitbox())) {
                    triggerGameOver();
                    return;
                }
                
                if (snowball.isOffScreen()) {
                    snowballs.splice(i, 1);
                }
            }
            
            gifts.forEach(gift => gift.draw());
            snowballs.forEach(snowball => snowball.draw());
            sledge.draw();
            drawGround();
            
            requestAnimationFrame(gameLoop);
        }

        // ============================================
        // RENDERING HELPERS
        // ============================================
        function drawBackground() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            const starPositions = [
                [50, 50], [150, 80], [300, 40], [420, 90], [200, 150],
                [80, 200], [380, 180], [450, 250], [120, 300], [350, 320]
            ];
            starPositions.forEach(([x, y]) => {
                ctx.beginPath();
                ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawGround() {
            const groundGradient = ctx.createLinearGradient(0, canvas.height - 15, 0, canvas.height);
            groundGradient.addColorStop(0, 'rgba(200, 220, 255, 0.3)');
            groundGradient.addColorStop(1, 'rgba(150, 180, 220, 0.5)');
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, canvas.height - 15, canvas.width, 15);
        }

        // ============================================
        // GAME OVER
        // ============================================
        function triggerGameOver() {
            isGameOver = true;
            
            const isNewHighScore = saveHighScore();
            
            // Save to daily leaderboard
            saveToDailyLeaderboard(playerName, score);
            const position = getLeaderboardPosition(playerName, score);
            
            // Update UI
            finalScoreDisplay.textContent = score;
            finalHighScoreDisplay.textContent = highScore;
            highScoreDisplay.textContent = highScore;
            
            newHighScoreMsg.style.display = isNewHighScore ? 'block' : 'none';
            
            // Show leaderboard position
            if (position <= CONFIG.LEADERBOARD_MAX_ENTRIES) {
                leaderboardPosition.style.display = 'block';
                if (position === 1) {
                    leaderboardPosition.innerHTML = 'üëë #1 on today\'s leaderboard!';
                } else {
                    leaderboardPosition.innerHTML = `üìä #${position} on today's leaderboard`;
                }
            } else {
                leaderboardPosition.style.display = 'none';
            }
            
            // Update leaderboard display
            renderLeaderboard();
            
            gameOverOverlay.classList.add('visible');
        }

        // ============================================
        // GAME RESET
        // ============================================
        function resetGame() {
            score = 0;
            level = 1;
            isGameOver = false;
            lastSpawnTime = 0;
            currentSpawnInterval = CONFIG.BASE_SPAWN_INTERVAL;
            currentFallSpeed = CONFIG.BASE_FALL_SPEED;
            
            gifts = [];
            snowballs = [];
            sledge = new Sledge();
            
            scoreDisplay.textContent = '0';
            levelDisplay.textContent = '1';
            
            gameOverOverlay.classList.remove('visible');
            
            requestAnimationFrame(gameLoop);
        }

        // ============================================
        // START GAME (with username)
        // ============================================
        function startGame() {
            playerName = usernameInput.value.trim();
            if (!playerName) return;
            
            // Save username for next time
            localStorage.setItem('santaSledRunPlayerName', playerName);
            
            // Show player info
            currentPlayerName.textContent = playerName;
            playerInfo.style.display = 'block';
            
            // Hide username overlay
            usernameOverlay.classList.remove('visible');
            
            // Start game
            isGameStarted = true;
            sledge = new Sledge();
            renderLeaderboard();
            requestAnimationFrame(gameLoop);
        }

        // ============================================
        // INPUT HANDLING
        // ============================================
        // Check if user is typing in an input field
        function isTypingInInput() {
            const activeElement = document.activeElement;
            return activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');
        }

        document.addEventListener('keydown', (e) => {
            // Don't capture game controls when typing in input fields
            if (isTypingInInput()) {
                // Only handle Enter key for starting the game
                if (e.key === 'Enter' && usernameOverlay.classList.contains('visible')) {
                    if (usernameInput.value.trim()) {
                        startGame();
                    }
                }
                return;
            }

            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keys.left = true;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keys.right = true;
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            // Don't process if typing in input
            if (isTypingInInput()) return;

            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keys.left = false;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keys.right = false;
            }
        });

        // Username input handling
        usernameInput.addEventListener('input', () => {
            startBtn.disabled = !usernameInput.value.trim();
        });

        // ============================================
        // TOUCH CONTROLS (Mobile Support)
        // ============================================
        // Touch zone elements for visual feedback
        const touchZoneLeft = document.getElementById('touchZoneLeft');
        const touchZoneRight = document.getElementById('touchZoneRight');

        // Update visual touch indicators
        function updateTouchZoneVisuals() {
            if (touchZoneLeft && touchZoneRight) {
                touchZoneLeft.classList.toggle('active', keys.left);
                touchZoneRight.classList.toggle('active', keys.right);
            }
        }

        // Handle touch input - left half moves left, right half moves right
        function handleTouchStart(e) {
            if (!isGameStarted || isGameOver) return;
            
            // Prevent default to avoid scrolling while playing
            e.preventDefault();
            
            // Process all touch points
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const canvasRect = canvas.getBoundingClientRect();
                const touchX = touch.clientX;
                
                // Check if touch is on left or right half of canvas
                const canvasCenterX = canvasRect.left + canvasRect.width / 2;
                
                if (touchX < canvasCenterX) {
                    keys.left = true;
                } else {
                    keys.right = true;
                }
            }
            
            updateTouchZoneVisuals();
        }

        function handleTouchEnd(e) {
            // Reset keys based on remaining touches
            keys.left = false;
            keys.right = false;
            
            // Re-check remaining touches
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const canvasRect = canvas.getBoundingClientRect();
                const touchX = touch.clientX;
                const canvasCenterX = canvasRect.left + canvasRect.width / 2;
                
                if (touchX < canvasCenterX) {
                    keys.left = true;
                } else {
                    keys.right = true;
                }
            }
            
            updateTouchZoneVisuals();
        }

        function handleTouchMove(e) {
            if (!isGameStarted || isGameOver) return;
            e.preventDefault();
            
            // Reset and recalculate based on current touch positions
            keys.left = false;
            keys.right = false;
            
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const canvasRect = canvas.getBoundingClientRect();
                const touchX = touch.clientX;
                const canvasCenterX = canvasRect.left + canvasRect.width / 2;
                
                if (touchX < canvasCenterX) {
                    keys.left = true;
                } else {
                    keys.right = true;
                }
            }
            
            updateTouchZoneVisuals();
        }

        // Add touch event listeners to canvas wrapper (covers the game area)
        const canvasWrapper = document.querySelector('.canvas-wrapper');
        canvasWrapper.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvasWrapper.addEventListener('touchend', handleTouchEnd, { passive: false });
        canvasWrapper.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        canvasWrapper.addEventListener('touchmove', handleTouchMove, { passive: false });

        // Button handlers
        startBtn.addEventListener('click', startGame);
        playAgainBtn.addEventListener('click', resetGame);

        // ============================================
        // RESPONSIVE CANVAS
        // ============================================
        function resizeCanvas() {
            const maxWidth = Math.min(480, window.innerWidth - 80);
            const scale = maxWidth / 480;
            
            if (scale < 1) {
                canvas.style.width = maxWidth + 'px';
                canvas.style.height = (600 * scale) + 'px';
            } else {
                canvas.style.width = '480px';
                canvas.style.height = '600px';
            }
        }

        window.addEventListener('resize', resizeCanvas);

        // ============================================
        // GAME INITIALIZATION
        // ============================================
        function initGame() {
            loadHighScore();
            resizeCanvas();
            
            // Load saved username if exists
            const savedName = localStorage.getItem('santaSledRunPlayerName');
            if (savedName) {
                usernameInput.value = savedName;
                startBtn.disabled = false;
            }
            
            // Show today's date on leaderboard
            leaderboardDate.textContent = getFormattedDate();
            
            // Render existing leaderboard
            renderLeaderboard();
            
            // Focus username input
            setTimeout(() => usernameInput.focus(), 100);
        }

        // Start initialization
        initGame();
    </script>
</body>
</html>
